<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/FileSaver.js/2014-11-29/FileSaver.js"></script>
</head>

<body>
    <button onclick="getdata1(1)">获取全国Id、特性、身高、体重、属性、种族值、努力值、英文名、</button>
    <button onclick="getdata2(1)">获取种族、捕获率、初始亲密度、颜色、蛋组、进化表、世代、性别比、性别差异、形态切换、形式描述、孵化步数、幼年宝可梦、中文名、日文名</button>
    <br>
    <button onclick="getdata3(1)">进化链</button>
    <br>
    <button onclick="getdataX(1)">获取XXX</button>
    <br>
    <button onclick="save()">save</button>

    <table>
        <thead>
            <tr>
                <th>全国Id</th>
                <th>中文名称</th>
                <th>英文名称</th>
                <th>日文名称</th>
                <th>属性</th>
                <th>身高</th>
                <th>体重</th>
                <th>种类</th>
                <th>孵化周期</th>
                <th>特性</th>
                <th>蛋组</th>
                <th>种族值</th>
                <th>努力值</th>
                <th>形态</th>
            </tr>
        </thead>
        <tbody id='tbody'>

        </tbody>
    </table>
</body>
<script>
    //https://pokeapi.co/api/v2/evolution-chain/  进化链
    //https://pokeapi.co/api/v2/ability/ 特性表   10000+之后是信长野望里的特性
    //'https://pokeapi.co/api/v2/egg-group/' 蛋组
    var 属性对照 = ['一般', '格斗', '飞行', '毒', '地面', '岩石', '虫', '幽灵', '钢', '火', '水', '草', '电', '超能力', '冰', '龙', '恶', '妖精']
    var 蛋组对照 = ['怪兽组', '水一组', '昆虫组', '飞行组', '陆上组', '妖精组', '植物组', '人形组', '水三组', '矿物组', '不定形组', '水二组', '百变怪', '龙组', '未发现组']
    var pokedata = []



    //获取全国Id、特性、身高、体重、属性、种族值、努力值、英文名
    //技能表和道具携带，没弄
    var getdata1 = (num) => {
        $.ajax({
            url: 'https://pokeapi.co/api/v2/pokemon/' + num,
            type: "GET",
            success: function (res) {
                return res
            }
        }).then(res => {
            console.log(res)
            pokedata[num - 1] = pokedata[num - 1] ? pokedata[num - 1] : {}

            let 全国编号 = ('000' + res.id).slice(-3)
            let 身高 = res.height / 10    //m
            let 体重 = res.weight / 10    //kg
            let 英文名 = res.name

            let 特性 = [null, null, null]
            res.abilities.map(x => {
                特性[x.slot - 1] = x.ability.url.split('/')[6] * 1
            })


            let 属性 = [null, null]
            res.types.map(x => {
                属性[x.slot - 1] = 属性对照[x.type.url.split('/')[6] - 1]
            })

            let 种族值 = [];  //速，特防，特攻，防，攻，hp
            let 努力值 = [];
            res.stats.map(x => {
                种族值.push(x.base_stat);
                努力值.push(x.effort)
            })

            let poke = {
                '全国编号': 全国编号,
                '特性': 特性,
                '身高': 身高,
                '体重': 体重,
                '属性': 属性,
                '种族值': 种族值,
                '努力值': 努力值,
                '英文名': 英文名,
            }

            Object.assign(pokedata[num - 1], poke)
        }).then(() => getdata1(num + 1))
    }

    //获取种族、捕获率、初始亲密度、颜色、蛋组、进化表、世代、性别比、性别差异、形态切换、形式描述、孵化步数、幼年宝可梦、中文名、日文名
    //...没弄
    var getdata2 = (num) => {
        $.ajax({
            url: 'https://pokeapi.co/api/v2/pokemon-species/' + num,
            type: "GET",
            success: function (res) {
                return res
            }
        }).then(res => {
            console.log(res)
            pokedata[num - 1] = pokedata[num - 1] ? pokedata[num - 1] : {}

            let 种族 = res.genera[0].genus
            let 捕获率 = res.capture_rate
            let 初始亲密度 = res.base_happiness
            let 颜色 = res.color.name
            let 蛋组 = []
            res.egg_groups.map(x => {
                蛋组.unshift(蛋组对照[x.url.split('/')[6] - 1])
            })
            let 进化表 = res.evolution_chain.url.split('/')[6] * 1
            let 世代 = res.generation.name.split('-')[1].toUpperCase()
            let 性别比 = res.gender_rate  //若不为-1,雌雄比 =[性别比例：8-性别比例];若为-1,无性别
            let 性别差异 = res.has_gender_differences
            let 形态切换 = res.forms_switchable //Mega、元素回归、达摩狒狒等
            let 形式描述 = res.form_descriptions //??
            let 孵化步数 = res.hatch_counter * 257  //2570步
            let 幼年宝可梦 = res.is_baby
            let 中文名 = res.names[0].name
            let 日文名 = res.names[1].name
            let 英文名 = res.names[2].name

            let poke = {
                '种族': 种族,
                '捕获率': 捕获率,
                '初始亲密度': 初始亲密度,
                '颜色': 颜色,
                '蛋组': 蛋组,
                '进化表': 进化表,
                '世代': 世代,
                '性别比': 性别比,
                //'性别差异':性别差异,
                //'形态切换':形态切换,
                //'形式描述':形式描述,
                '孵化步数': 孵化步数,
                //'幼年宝可梦':幼年宝可梦,
                '中文名': 中文名,
                '日文名': 日文名,
            }

            Object.assign(pokedata[num - 1], poke)

        }).then(() => getdata2(num + 1))
    }

    var getdata3 = (num) => {
        $.ajax({
            url: 'https://pokeapi.co/api/v2/evolution-chain/' + num,
            type: "GET",
            success: function (res) {
                return res
            },
            error: function (err) {
                return err
            }
        }).then(res => {
            console.log(res.chain.species.name)

            let id = res.id

            let species = res.chain.species.url.split('/')[6] * 1;
            let chain = []



            function ddd(x) {
                var str = "";
                var iconNum = 0;
                var icon = [null, null]
                if (x.min_level) {
                    str += x.min_level + "级 "
                }
                if (x.gender == 2) {
                    str += "雄性"
                } else if (x.gender == 1) {
                    str += "雌性"
                }
                if (x.needs_overworld_rain) {
                    str += "下雨时"
                }
                if (x.trade_species) {
                    str += "与" + x.trade_species.name
                    iconNum += 1
                    icon[0] = '精灵'
                    icon[1] = x.trade_species.url.split('/')[6] * 1;
                }
                if (x.party_species) {
                    str += "队伍里有" + x.party_species.name
                    iconNum += 1
                    icon[0] = '精灵'
                    icon[1] = x.party_species.url.split('/')[6] * 1;
                }
                if (x.party_type) {
                    str += "队伍里有" + x.party_type.name + "系精灵"
                }
                if (x.turn_upside_down) {
                    str += "翻转3DS"
                }

                if (x.min_affection) {
                    str += "羁绊" + x.min_affection + "心"
                }

                if (x.min_beauty) {
                    str += "美丽度" + x.min_beauty + "点"
                }

                if (x.min_happiness) {
                    str += "亲密度" + x.min_happiness + "点"
                }

                if (x.time_of_day) {
                    str += "在" + x.time_of_day + "时间段"
                }

                if (x.location) {
                    str += "在" + x.location.name + "附近"
                }

                if (x.known_move) {
                    str += "学会" + x.known_move.name + "技能后"
                    iconNum += 1
                    icon[0] = '技能'
                    icon[1] = x.known_move.url.split('/')[6] * 1;
                }
                if (x.known_move_type) {
                    str += "学会" + x.known_move_type.name + "属性技能后"
                }
                if (x.held_item) {
                    item = x.held_item.url.split('/')[6] * 1;
                    str += "携带道具"
                    iconNum += 1
                    icon[0] = '道具'
                    icon[1] = x.held_item.url.split('/')[6] * 1;
                }
                if (x.item) {
                    item = x.item.url.split('/')[6] * 1;
                    str += "使用道具"
                    iconNum += 1
                    icon[0] = '道具'
                    icon[1] = x.item.url.split('/')[6] * 1;
                }
                switch (x.trigger.name) {
                    case "level-up": str += "升级进化"; break;
                    case "trade": str += "通信进化"; break;
                    case "use-item": str += "进化"; break;
                    case "shed": str += "队伍有空位时"; break;
                }

                return {
                    'str': str,
                    'iconNum': iconNum,
                    'icon': icon,
                };
            }

            function ccc(x) {
                return x.map(x => {
                    return {
                        'species': x.species.url.split('/')[6] * 1,
                        'details': x.evolution_details.map(x => ddd(x)),
                        'details_times': x.evolution_details.length,
                        'chain': ccc(x.evolves_to)
                    }
                })
            }

            pokedata[num - 1] = {
                'id': id,
                'species': species,
                'chain': ccc(res.chain.evolves_to)
            };



        }, err => {
            console.log(err)
            pokedata[num - 1] = err
        }).then(() => {
            if (num < 430) {
                getdata3(num + 1)
            }
        })
    }

    var getdataX = (num) => {
        $.ajax({
            url: 'https://pokeapi.co/api/v2/evolution-chain/' + num,
            type: "GET",
            success: function (res) {
                return res
            },
            error: function (err) {
                return err
            }
        }).then(res => {
            console.log(res)
        }, err => {
            console.log(err)
        }).then(() => { })
    }

    function save() {
        let content = JSON.stringify(pokedata);
        let blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        saveAs(blob, "save.json");
    }
</script>

</html>